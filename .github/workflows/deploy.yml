name: Deploy Next.js App to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Deploy via SSH
      - name: SSH and deploy to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # -----------------------------
            # Navigate to project directory or clone if first-time
            # -----------------------------
            PROJECT_DIR=/var/www/www.ezdokani.com
            if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "First-time setup: cloning repo..."
              mkdir -p $PROJECT_DIR
              git clone https://github.com/mdsamialsohan/DukanFrontend-dev.git $PROJECT_DIR
            fi
            cd $PROJECT_DIR

            # Ensure repo is synced
            git fetch --all
            git reset --hard origin/main

            # -----------------------------
            # Check if Dockerfile exists
            # -----------------------------
            if [ ! -f "$PROJECT_DIR/Dockerfile" ]; then
              echo "Dockerfile missing! Deployment aborted."
              exit 1
            fi

            # -----------------------------
            # Stop and remove all old containers
            # -----------------------------
            OLD_CONTAINERS=$(sudo docker ps -a -q -f name=nextapp)
            if [ -n "$OLD_CONTAINERS" ]; then
              sudo docker stop $OLD_CONTAINERS || true
              sudo docker rm $OLD_CONTAINERS || true
            fi

            # Remove any "Created" containers from previous builds
            CREATED_CONTAINERS=$(sudo docker ps -a -q -f status=created -f ancestor=nextapp)
            if [ -n "$CREATED_CONTAINERS" ]; then
              sudo docker rm $CREATED_CONTAINERS || true
            fi

            # -----------------------------
            # Build new Docker image
            # -----------------------------
            echo "Building Docker image..."
            if ! sudo docker build --no-cache -t nextapp .; then
              echo "Docker build failed! Deployment aborted."
              exit 1
            fi

            # -----------------------------
            # Run new container
            # -----------------------------
            sudo docker run -d -p 3000:3000 --name nextapp nextapp

            # -----------------------------
            # Test Nginx config and reload
            # -----------------------------
            if sudo nginx -t; then
              sudo systemctl reload nginx
            else
              echo "Nginx configuration test failed! Deployment aborted."
              exit 1
            fi

            # -----------------------------
            # Optional: simple health check
            # -----------------------------
            echo "Waiting for app to start..."
            sleep 30

            echo "Checking app health..."
            if ! curl -s http://127.0.0.1:3000 > /dev/null; then
              echo "Next.js container failed to start!"
              exit 1
            fi

            echo "Deployment successful!"
